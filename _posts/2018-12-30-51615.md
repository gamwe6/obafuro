---
layout: post
title: Google Load Balancer のセッションアフィニティについて
date: 2018-12-30 05:00:59
categories: google-cloud google-compute-engine
---
<p>LB配下に2つのWEBサーバを設置したデータ検索エンジンを用途とした構成を構築しています。<br>
しかし複数人でアクセスしているときに以下の事象が発生されます。<br>
・A系WEBサーバを使用している最中にB系WEBサーバに分散されてしまい、セッションが維持できずログイン画面に戻る事象が発生（再現済み）</p>

<p>原因としては、高負荷時において発生していることがわかっているのですが以下設定パラメータのとおり、アフィニティの設定をしております。<br>
期待している動きは、セッションアフィニティが維持され、接続中のサーバは別のサーバに分散されず維持されており、新規アクセスユーザはB系WEBサーバへ転送されることになります。</p>

<p>設定が足りないのかGoogle LBの仕様によるものなのか、どなたかご教示いただけないでしょうか。</p>

<p><em>LBの設定</em><br>
分散モード：CPU<br>
最大使用率：80%<br>
容量：100%<br>
セッションアフィニティ：生成したCookieアフィニティ<br>
Cookie TTL：1800秒<br>
接続ドレインのタイムアウト：300秒<br>
セキュリティポリシー：なし</p>
