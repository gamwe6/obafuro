---
layout: post
title: node.jsの内部バッファ値を増やしたい
date: 2017-03-16 07:40:16
categories: node.js
---
<!-- {% raw %} -->
<p>○問題</p>

<p>node.jsでプロキシを書いています。<br>
重いPOSTコンテンツをプロキシすると途中で切断されるという現象が起きました。</p>

<p>①クライアント　→　②node.jsプロキシ　→　③Webサーバー</p>

<p>プロキシの方法としては、②のところでdataイベントで受けたchankを少しずつWebサーバーへ送っています。<br>
この方法だと途中でnode.jsが耐え切れなくなるのか、重いコンテンツをPOSTすると切断されてしまいます。軽いコンテンツのPOSTはうまくいきます。</p>

<p>ちなみに、一度クライアントからPOSTデータを全て受け取ってからWebサーバーへリクエストを送信するとうまく動きます。<br>
うまくいかないのは、dataイベントで受信しつつWebサーバーへ送信を繰り返す処理の場合です。</p>

<p>色々調べたところ、<br>
node.jsのstreamは内部にhighWaterMarkというバッファを持っていて、この総量に限界が来ているのではないかと思っています。</p>

<p>このhighWaterMarkを増やす方法はありますか？</p>

<p>Httpサーバーは普通の作法で以下のように作成しています。</p>

<pre><code>https.createServer(options, function (request, response) {
</code></pre>

<p>このrequestとresponseのそれぞれのhighWaterMarkを増やすことができれば解決すると考えています。</p>

<p>steramのコンストラクタでhighWaterMarkを増やせるのは調べてわかりましたが、上記のような生成されたオブジェクトで増やすことは可能なのでしょうか？</p>

<p>ソースコードは理由があって全て載せられないですが、<br>
基本的に無理な負荷をかけなければ正しく快適に動くのでプログラムのどこかが間違っているということは無い前提で答えていただいてかまいません。</p>

<p>補足</p>

<p>書き忘れましたが、node.jsの公式サイトを見るとPIPEで繋げば内部バッファを気にしなくていいみたいなことが書かれていましたが、PIPEで繋いでもやはり負荷によるエラーが発生します。<br>
ですので、内部バッファを増やすことができないかと考えました。</p>
<!-- {% endraw %} -->
