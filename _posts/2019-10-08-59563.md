---
layout: post
title: ロックエスカレーションによって1つのトランザクションだけでデッドロックはあり得るか？
date: 2019-10-08 06:59:10
categories: sql-server
---
<!-- {% raw %} -->
<p>SQLServer 2017 Standard とします。<br>
以下のようなトランザクションがあります。<br>
（注）記述の通り、レコードR1/R2はともにページPに配置されている。</p>

<ol>
<li>テーブルTのレコードR1に更新をかける<br>
1-2. レコードR1に対してXロック要求、獲得<br>
1-3. レコードR1を含むページPにIXロック要求、獲得</li>
<li>テーブルTのレコードR2をSELECT<br>
2-1. レコードR2に対してSロック要求・・・<br>
2-2. しかしここでロックエスカレーションが発生<br>
2-3. エスカレーションにより、レコードR2を含むページPにSロックを要求<br>
2-4. ページPは既にIXロックがかかっているので、Sロックが獲得できない？</li>
</ol>

<p>この後、IXロック解放待ちで止まってデッドロックってことになっちゃいますが、１つのトランザクションでデッドロックって、変ですよね。<br>
多分起きないだろうと思っていますが、それを解決するメカニズムが分からず。<br>
SQLServerの「SIXロック」が何なのか、説明を見てもよく分からなかったのですが、もしかしてこのときにSIXロックになるのでしょうか？</p>
<!-- {% endraw %} -->
