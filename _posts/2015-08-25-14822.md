---
layout: post
title: pg_dumpでサーバが停止してしまう
date: 2015-08-25 07:31:50
categories: php apache postgresql
---
<p>現在apache2.2、postgresql8.3.3、PHP5.3を利用しております。<br>
起こった現象は表題の通りですが、以下に行った操作を列挙します。</p>

<p>・新たにシステムへ手を加えるにあたりデータベースのバックアップを行うべくpg_dumpを発行した。<br>
・始めは問題なかったが、15分ほど経過した頃システムにつながらないことを確認。<br>
・pg_dumpをCtrl+Cで中断。<br>
・topコマンドで確認したところ、load averageが50くらい、cpu消費がsy20,waが70程度、またスワップ領域をかなり利用していた。<br>
・psコマンドで確認したところ、大量のselectプロセスが溜まっていた。<br>
・しばらくしたところサーバが応答を受け付けなくなった。<br>
・再起動を行ったが、新たにselectプロセスが発生しすぐにサーバが操作不能の状態になった。<br>
・再度再起動を行い、postgresqlを停止したところ、操作可能の状態に復帰した。<br>
・その後、また再起動したところ問題なくシステムが稼働している。</p>

<p>以上のようなことが起こったのですが、その後の調査でも再現せず、原因がつかめておりません。<br>
以上の時システムは稼働中であり、利用者がいくらかいたと思われます。<br>
またpostgresqlのログを確認したところ、その前後で大きなデータのupdateとselectが何度か走っていることがわかりました（一件当たりが大きく、5万文字のデータ）。<br>
ちなみにpg_dumpは毎日利用者の少ない時間に走っており、特にエラー等は出ておりません。</p>

<p>環境は以下の通りです。<br>
Apache 2.2<br>
Postgresql 8.3.3（データベースのサイズは、ダンプしたところ数十Gほど）<br>
PHP 5.3<br>
メモリ 16GB</p>

<p>どなたかお力を貸していただけないでしょうか。<br>
よろしくお願いします。</p>
