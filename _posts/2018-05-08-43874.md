---
layout: post
title: rails (ruby) で forever 的なことがやりたい際のベストプラクティス
date: 2018-05-08 14:36:56
categories: ruby-on-rails ruby
---
<p>バックグラウンドのバッチ処理を rails (のサブセット: ActiveRecord などのみ使う) で記述しています。結果、 <code>Application#load_tasks</code> により <code>bundle exec rake</code> コマンドでバッチをコマンドで実行できる状態になっていたとします。</p>

<p>この時に、バッチのメインループを、失敗しようが成功しようが、ある一定のインターバルを挟んだ上で、ひたすらループしたいと考えています。これは、どう実現するのがベストでしょうか?</p>

<p>似たようなことを実現する上で、有名なツールとして <code>whenever</code> がありますが、これは cron による定期実行をサポートするツールであって、「秒単位でインターバルを指定しながらひたすらループしたい」という今回やりたいことは満たせないと思っています。</p>

<p>また、同じ系統のツールたちに、 もろもろの job queue (active_job でサポートされるような) がありますが、 redis を前提としているものが大半であったりして、わりと、オーバーキルな気がしています。</p>

<p>運用でどうにかするという観点では、現在では以下のように tmux session と shell script を組み合わせています。</p>

<pre><code>tmux new-session -s セッション名 -d 'while true; do 実行したいコマンド; sleep インターバル; done'
</code></pre>

<p>ただ、この方法は、なんというかあまり rail にのっかっていないというか、ちょっと気をつかわないと上手く動かなかったりするので、これをよろしくやってくれるライブラリなどがあれば知りたいな、と思っています。</p>
