---
layout: post
title: 検索ロジックにおけるバックスラッシュとワイルドカードのエスケープ処理
date: 2019-04-26 08:49:12
categories: php sql 正規表現 検索
---
<!-- {% raw %} -->
<p>検索ロジックの改修で、<code>*</code>をワイルドカードとして扱う改修を行っています。<br>
（SQLで言う%と同じ扱いです。）<br>
<code>*</code>のエスケープは、<code>\*</code>としています。</p>

<p>結果として、検索文字列に対して、以下の変換処理を行い、その文字列でSQLの発行を行うようにしました。</p>

<pre><code>$search_val = preg_replace('/(?&lt;!\\\)\*/', '%', $search_val_base);
</code></pre>

<p>上記コードにて、<br>
<code>*  =&gt; %</code> と変換<br>
<code>\* =&gt; \*</code> と変換しないようにして、エスケープに対応しました。</p>

<p>しかし、このコードですと、バックスラッシュが複数あるケースには対応できませんでした。</p>

<p>例:<br>
理想: <code>\\* =&gt;\\%</code> 、実際: <code>\\* =&gt;\\*</code><br>
理想: <code>\\\* =&gt;\\\*</code> 、実際: <code>\\\* =&gt;\\\*</code><br>
理想: <code>\\\\* =&gt;\\\\%</code> 、実際: <code>\\\\* =&gt;\\\\*</code></p>

<p>上記のように、バックスラッシュが偶数個の時は変換が必要、奇数個の時は変換が不要となっているので、偶数/奇数での判定を考えたのですが、正規表現での偶数個/奇数個の判別はできそうにありませんでした。</p>

<p>また、プログラム(PHP)上での文字列操作も考えたのですが、PHPではバックスラッシュを２つ重ねると、エスケープ処理と判定されるようで、バックスラッシュ１つとの判別ができないと考えています。</p>

<p>例:</p>

<pre><code>$val = "aaa*aaa\*aaa\\*aaa\\\*aaa";
</code></pre>

<p>をvar_dump()で出力すると、</p>

<pre><code>string(23) "aaa*aaa\*aaa\*aaa\\*aaa"
</code></pre>

<p>と出力されます。</p>

<p>以上を踏まえて、下記の疑問に回答いただけないでしょうか</p>

<p>質問１．正規表現で偶数個/奇数個の判別は可能か？<br>
質問２．PHPでの<code>\</code>と<code>\\</code>の判別<br>
質問３．何か他にアイディアがあれば…</p>
<!-- {% endraw %} -->
