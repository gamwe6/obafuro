---
layout: post
title: "3秒程度かかるAPIコールについて"
date: 2017-09-25 05:21:46
categories: ruby-on-rails
---
<p>下記の仕様のAPIの設計をどうしたらいいかアドバイスをいただきたいです。</p>

<h3>APIの仕様</h3>

<ul>
<li><a href="http://example.com/hoge?url=http://yahoo.com" rel="nofollow noreferrer">http://example.com/hoge?url=http://yahoo.com</a> をGETで叩くと、<br>
urlパラメーターで指定したページのスクリーンショット画像を閲覧できるurlをjsonで返却する(スクリーンショットした画像をAWSのS3などにアップロードし、そのURLを返す)</li>
<li>このAPIでは、このURLをスクリーンショットとってね、ということ以外に処理をする(そっちはレコード一個作るくらいなので重くない処理）</li>
<li>クライアントから数秒間は画像が見れなくても大丈夫</li>
<li>なるべく短いレスポンスタイムにしたい</li>
</ul>

<h3>APIの叩き方</h3>

<ul>
<li>iOSやAndroidなどのクライアントから非同期通信でAPIを叩く</li>
<li>APIの戻り値は現状でハンドリングしてなく、遅くなってもUXは悪化しない

<ul>
<li>画像を遅延読み込みみたいな感じで表示させるので、そこのUXは悪化しますが</li>
</ul></li>
</ul>

<h3>懸念</h3>

<ul>
<li>スクリーンショットを取得するのに、サーバー側でPhantomJSなどを使うとレスポンスタイムが3秒はかかってしまう</li>
<li>レスポンスタイムが長いため、普通にAPIとして作るとサーバー側の負荷が心配</li>
</ul>

<h3>こんな設計？</h3>

<ol>
<li>APIを叩いた時に、スクリーンショット取得するURLをキューにため、そのAPIはさっさとレスポンスを返す。キューにたまったURLをデーモンで処理し次々とスクリーンショットを取得。iOSやAndroidからは定期的に「スクリーンショット取れましたかAPI」を叩いて、さっき自分が送ったURLのスクリーンショットが取得できているかどうか確認する</li>
<li>1ではクライアントから、スクリーンショットとれたー？というAPIを叩いていたが、それをせずに、デーモンでスクリーンショット取得後にPush通知でiOSやAndroidに知らせる</li>
<li>普通に最初のリクエストでスクリーンショットとるところまでやって、レスポンス返す（レスポンスタイム長くなりますが）</li>
<li>socket通信</li>
<li>他に何かよい案があればお願いします。</li>
</ol>

<h3>補足</h3>

<p>Rails4.2.6をAWSのEC２上で動かしてます。</p>
