---
layout: post
title: "ASP.NET MVCのWeb ApiでUnmanaged dllを使用するとOS再起動時の呼び出しが固まる"
date: 2017-02-22 07:54:26
categories: asp.net
---
<p>タイトルの通りの現象に困っています</p>

<p>サーバーは Windows Server 2012 R2<br>
開発環境はVisual Studio 2015 + ASP.NET (.NET Framework 4.6.2)  <br>
です</p>

<p>ざっくり現象を書くと<br>
Unmanaged dllを使ったWeb APIを呼ぶと固まってしまう<br>
同様の処理をCのCGI(exe)で実行するとちゃんと動く<br>
です</p>

<p>いろいろ試した結果を含めて詳細を以下に書きます</p>

<hr>

<ol>
<li><p>サードパーティ製ライブラリを2種類使用するUnmanaged dll(64bit)を作成しています（このDLLを①とします）</p></li>
<li><p>C言語のコンソールアプリで①をリンクして関数を呼ぶものを作りました（②）<br>
MVCのWeb Api 2コントローラーを作成して①を呼ぶものを作りました（③）</p></li>
<li><p>②，③はサーバーに配置してどちらもIISを通して呼ぶようにしました</p></li>
<li><p>サーバーを再起動してサービスが立ち上がったと思われるタイミングで②を呼ぶと常識的な時間で応答を返してくれました</p></li>
<li><p>同じことを③で試すと応答がかえって来ません（クライアント側のタイムアウトや、アプリケーションプールのPingエラーで強制終了させられる）<br>
この状態は30分ほど待っても改善しません（それ以上は待っていないのでわかりません）</p></li>
<li><p>②を呼んだあと③を呼ぶと1,2回くらいの試行で応答を返してくれます</p></li>
<li><p>一度でも応答を返すとあとは普通に応答を返します<br>
iisresetコマンド等で再起動しても返します</p></li>
<li><p>サーバーを再起動すると元（応答を返さない状態）に戻ります</p></li>
<li><p>「起動が遅い」等で調べると<code>&lt;generatePublisherEvidence enabled="false"/&gt;</code>が出てきたので試してみましたが変わりませんでした(v4以降は関係ないという記述もありましたし、今はサーバーをインターネットにつないでいる状態ですが変化なしです)</p></li>
<li><p>①の各ステップでログを出力するようにしたところ、サードパーティ製ライブラリの初期化周辺で止まっているようなのですが、止まる箇所は固定ではありませんでした（ログは毎回flushして閉じているので多分止まる直前を示していると思います）</p></li>
</ol>

<hr>

<p>という感じでして途方に暮れています<br>
原因や回避策があれば教えていただけますでしょうか</p>
