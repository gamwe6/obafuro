---
layout: post
title: "C++でハッシュテーブルを用いたデータベースのような物を考えています。"
date: 2015-03-06 14:41:30
categories: c++ c++11
---
<p>開発環境:<br>
Windows7 x64 の VirtualBox 上の<br>
CentOS7(多分x64) g++</p>

<p>ハッシュテーブルの概念自体は、いろいろなサイトで説明されているので、自作も考えましたが、<br>
速度など考えるといろいろ試してみたりと、大変なので、<br>
今回は<code>unordered_map</code>の使用を想定しています。</p>

<p>ちょっとしたクローラー的な物を開発しており(他サイトに迷惑を掛ける事はまず無いです。)、<br>
仮想環境上で上手く動作すれば、8G程度のメモリを乗せたマシンでも安く組んで、<br>
その上で動かそうと考えています。</p>

<p>そこで、<code>unordered_map</code>を用いて、<br>
過去に調べたデータの[履歴]や、収集した[データ]の格納を考えています。</p>

<p>ここで、[履歴]の方はクロール時に毎回アクセスする事になります。<br>
しかし、[データ]については、([データ]を解析した後、)最悪破棄しても問題ありません。(アクセスする事は稀です。)</p>

<p>となると、<code>unordered_map</code>を用いて、<br>
[履歴]と[データ]を等しく格納するのはメインメモリの無駄遣いのように思います。<br>
これらを切り分けて格納する事はできるでしょうか？</p>

<p>&lt;&lt;質問①>><br>
要するに、[履歴]は頻繁にアクセスするのでO(1)でアクセスしたい。<br>
[データ]は、そのままHDDに格納してしまいたい。<br>
ただし、[データ]には[履歴]と同じキーワード(ハッシュ値)で、<br>
それなり(……このそれなりが曲者かもしれないですが)の速度でアクセスしたい。O(N)はさすがに困る。</p>

<hr>

<p><code>unordered_map</code>は、<br>
<a href="http://vivi.dyndns.org/tech/cpp/unordered_map.html#assign" rel="nofollow">http://vivi.dyndns.org/tech/cpp/unordered_map.html#assign</a><br>
などで説明されており、<br>
「全てのキー・値の取得」する場合は、</p>

<pre><code>std::unordered_map&lt;std::string, int&gt; mp
// いろんな値を設定;
for(auto itr = mp.begin(); itr != mp.end(); ++itr) {
    std::cout &lt;&lt; "key = " &lt;&lt; itr-&gt;first           // キーを表示
                    &lt;&lt; ", val = " &lt;&lt; itr-&gt;second &lt;&lt; "\n";    // 値を表示
}
</code></pre>

<p>(上記URLより引用)<br>
のようにすればいいようです。</p>

<p>例えばマシンをシャットダウンする場合、<br>
当然メモリ上のハッシュテーブルを上記のような方法で退避する必要があると思います。<br>
しかし、この方法で退避すると、HDDの容量こそ削減できるものの、<br>
再起動時にハッシュ値を全て再計算する事になると思います。</p>

<p>&lt;&lt;質問②>><br>
ハッシュテーブルのバイナリをそのままHDDに退避する事は可能ですか？<br>
(全て自作ならこのくらいはそれ程難しい話しではないと思うのですが……たぶん)</p>

<p>あるいは、一件一件退避するとして、そのコストは……どの程度でしょうか？<br>
(もちろん規模と実装に依るのは分かっているのですが、<br>
 見当が付かないので、どうすればいいか困っています。<br>
 処理が30秒で終わるのか、1時間かかるのか。        )</p>

<hr>

<p>&lt;&lt;質問③>><br>
<code>unordered_map</code>を用いるとして、ハッシュテーブルのサイズが、<br>
メインメモリの容量を越えてしまった場合、どうなるのでしょうか？</p>

<p>また、その場合の解決策について教えて下さい。</p>

<hr>

<p>最後に、<br>
MySQLなどのデータベース?がC++から使えるかどうかは良く分かりませんが、<br>
取りあえず、今回は余り使いたくないです。<br>
ライセンスを気にしなくてはいけない程のコードは書いていませんが、<br>
巻き込まれたくは無いです。</p>

<p>ただ、もし、随分と簡単にMySQLなどのデータベースが、<br>
この問題を明快に解決してくれるのであれば、<br>
使えて損は無いので、ちょっと気になります。<br>
(でもなるべくC++で作りたい、というのが本音です。)</p>
