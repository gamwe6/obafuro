---
layout: post
title: ２次元配列は不連続か？
date: 2015-01-22 00:14:03
categories: c 言語仕様
---
<!-- {% raw %} -->
<p>本家の方でちょっと<a href="https://stackoverflow.com/questions/28070669/storage-mapping-function-for-multi-array-in-c/28070811#28070811">議論</a>になったのですが、英語には弱く知識も不十分ということもあって英語での議論では相手の主張がよく納得ができなかったのでこちらで質問させて頂きたいと思います。</p>

<p>簡単な例を挙げれば、<code>short array[n][m];</code>という配列がある時、</p>

<pre><code>short *p = &amp;array[0][0];
for(int i = 0;i &lt; n*m; ++i)
    *p++ = 1;
</code></pre>

<p>は、</p>

<pre><code>for(int i = 0; i &lt; n; ++i)
    for(int j = 0; j &lt; m; ++j)
        array[i][m] = 1;
</code></pre>

<p>と<br>
同じ挙動をすることが保証されているか？<br>
言い換えれば、２次の配列はその最小要素(つまり<code>short int</code>)が連続していることが保証されているか？<br>
ということです。</p>

<p>標準では、「配列はその要素は連続しており隙間はない」とされていますが、<br>
その方の主張によると、<br>
「１次元配列は確かにそうであるが、２次元配列は必ずしもそうではない。」<br>
例えば<code>short a[2][7];</code>のような副配列を考える時、<br>
Ｃでは２次元配列は配列の配列であり、その意味で要素として<code>short [7];</code>は隙間なく連続しているが、<br>
副配列である<code>short [7];</code>の最後には調整パディングが付与されているかもしれない。<br>
そのような場合2次元配列全体としてみると連続していない。<br>
（つまり先述の例のような場合の動作は保証されない）</p>

<p>確かに副配列の最後にパディングが存在しても標準の言と矛盾しないとは思いますが、<br>
そもそもそのような（配列でパディングが付与される）ことがあるのかどうかも疑問です。<br>
（構造体でメンバー間でパディングがある場合があることは承知しています、しかし配列の最後にパディングが付与され<code>sizeof(short[7])</code>が<code>8*sizeof(short)</code>になるとは思えません。）<br>
例えば、<code>short a[4];</code>も<code>short b[5];</code>もアラインメントの問題なくアクセスできます、<br>
そのような手段がある(つまり最小構成要素である<code>short</code>にアクセスできる)中で<code>short a[14]</code>(連続している)を解釈上<code>short a[2][7];</code>(不連続である？)と内部の表現が違うというのは納得できません。<br>
そのようなパディングがそもそも必要無いと思うし、<br>
もしそのようなパディングが存在するような内部イメージを持つならアドレス演算を複雑にするだけだと思います。(Ｃの理念に反する？)</p>

<p>また、対象としている配列が</p>

<pre><code>sizeof(array) == n*m*sizeof(array[0][0])
</code></pre>

<p>が真である場合にはそのようなパディングが存在しない、<br>
なので、この場合連続であるといってもよく、先述の例の動作は保証される。<br>
と思ったのですが、<br>
「それでも動作は保証されない。境界制約のルールに違反する。」<br>
と言われました。<br>
私の理解としては、<code>short *p = &amp;array[0][0];</code> のようなことは最小構成要素が同じ<code>short</code>であり、連続している場合（つまりメモリのサイズが同じでパディングを有していないと考えられる場合）問題無いと思えます。(逆に最小構成要素が異なる場合、例えば<code>char *</code>を<code>int *</code>に変換して<code>int</code>でアクセスすることは問題がある。)</p>

<p>私の理解が間違っているとしたら何が間違っているのでしょうか？<br>
このようなこと（連続か不連続か）をハッキリさせるような文言が標準にありますか？</p>

<hr>

<p>長くて要点がはっきりしない部分もあると思うのでまとめを追加します。</p>

<p>Ｑ：多次元配列は不連続か？（不連続の意味合いの説明はもういいと思うので略）<br>
Ａ：<br>
標準に記載がない以上、連続かも知れないし、不連続かもしれない。<br>
不連続かも知れないので不連続だとして扱う必要がある。<br>
（つまりサンプルコードの動作は保証されないものとしなければならない）</p>

<p>Ｑ：では、連続すると判断ができた場合のサンプルコードの動作は保証されるか？<br>
Ａ：（私の理解では保証される）</p>

<p>Ｑ：自分のシステム＋コンパイラで連続する（あるいは不連続）と判断するためにどのようなコードを書けばよいか？<br>
Ａ：（私の理解では<code>sizeof(array) == n*m*sizeof(array[0][0])</code>のようなもの）</p>
<!-- {% endraw %} -->
