---
layout: post
title: ソケットのsend()の使い方とオーバーヘッドについて
date: 2015-04-27 02:33:25
categories: linux c++ socket tcp 非同期
---
<!-- {% raw %} -->
<p>C++で非同期通信を実装しています。環境はLinux(今のところUbuntuとCentOSが前提)。<br>
このクラスを使用する側は、任意のタイミングで好きなだけsend()を使える仕様で考えています。</p>

<pre><code>例：
myAsyncClass myAsync;
myAsync.connect("host");

myAsync.send(buf1,len1);  // ←非同期で処理されてすぐリターンする.
myAsync.send(buf2,len2);  // ←非同期で処理されてすぐリターンする.
myAsync.send(buf3,len3);  // ←非同期で処理されてすぐリターンする.

// 受信はあらかじめ登録したコールバックか何かで行う.
</code></pre>

<p>内部でソケットが書き込み可能になったらシステムコールのsend()を呼びます。<br>
しかし、なるべくシステムコールの呼び出し回数は少ない方が良いため、書き込み可能になった時にbuf1とbuf2とbuf3を全て持っていたら、それらを連結して一回だけsend()を呼ぼうかと思っています。</p>

<p>ですが、buf1とbuf2とbuf3のメモリを連結するためには、buf1の末尾(あるいは自分で用意した別バッファ)へ動的確保を行い、buf2とbuf3をコピーするコストが発生します。</p>

<p>ここで迷っているのは、メモリの確保とコピーを行うくらいなら、素直にsend()を3回呼んだ方がコストが少ないのではないか？ということです。</p>

<p>このあたりの知見をお持ちの方がいらしたらアドバイスお願いします。<br>
もちろんケースバイケースで、コピーする頻度や量にもよるという意見もあるかと思いますが。。</p>
<!-- {% endraw %} -->
