---
layout: post
title: ロードバランサを用いたWebサーバ複数台構成にNFSファイル共有を使用したが応答速度が遅い
date: 2017-10-12 02:58:07
categories: linux サーバー管理
---
<p>さくらクラウドを利用しています。</p>

<p>元々はサーバー1台で稼働させていたのですが、ピーク時のスケールアウトのため、ロードバランサを用いて以下のような2台構成を試みたところ、1時間あたり5000PVを超えたあたりからWebサーバーの応答速度が非常に遅くなる(chromeのデベロッパーズツール->networkでTTFBが3秒以上)現象が発生し、その後PVの増加とともに応答速度の遅延時間が伸びていきました。</p>

<p>ただ、応答速度が遅くなるにもかかわらずサーバーA、サーバーBともCPU、メモリ、ロードアベレージ、DiskI/O等についてはサーバー監視ソフトのMuninで確認したところ、使用率が突出するといったことは見受けられませんでした。</p>

<p>追記：<br>
当時のCPUのIO WaitとメモリのSWAPです。<br>
[IO Wait(%)]サーバーA<br>
・時間帯 4:50～5:50 特に動作に問題が無かった時間帯<br>
Cur:2.93、Min:1.98、Avg:3.10、Max:4.39<br>
・時間帯 6:25～7:25 応答が遅くなっていた時間帯<br>
Cur:1.84、Min:1.81、Avg:3.17、Max:4.61</p>

<p>[IO Wait(%)]サーバーB<br>
・時間帯 4:50～5:50 特に動作に問題が無かった時間帯<br>
サーバーBはこの時間帯記録の取得に失敗しておりました<br>
・時間帯 6:25～7:25 応答が遅くなっていた時間帯<br>
Cur:7.64、Min:4.80、Avg:6.34、Max:8.00</p>

<p>[SWAP(GB)]こちらはサーバーA,B共に0.00<br>
・時間帯 4:50～5:50 特に動作に問題が無かった時間帯<br>
Cur:0.00、Min:0.00、Avg:0.00、Max:0.00<br>
・時間帯 6:25～7:25 応答が遅くなっていた時間帯<br>
Cur:0.00、Min:0.00、Avg:0.00、Max:0.00</p>

<p>設定や構成等を見直せば改善するのか、そもそもnfsによるスクリプト＆データの共有によるサーバー分散構成に無理があるのか、といった部分が判断できず質問させていただきました。</p>

<p>CentOS6.9でファイルシステムはext4を利用しています。<br>
(以下IPアドレスはダミーです)</p>

<p>【さくらクラウド上のサーバースペック】<br>
・サーバーA<br>
CPU：20コア、メモリ：32GB<br>
・サーバーB<br>
CPU：16コア、メモリ：32GB<br>
・ロードバランサ<br>
　ハイスペックプラン、冗長化なし<br>
　送信トラフィック: 1Gbps、受信トラフィック: 500Mbps、セッション数: 10,000、セッション、毎秒接続数: 3,000cps程度</p>

<p>【ディレクトリ共有に関する設定】<br>
・サーバーA(IP=99.100.101.1)<br>
Webサーバーとして稼働、またデータ(テキストファイルベース)とPHPスクリプトを格納。<br>
/var/www/scripts/ ・・・自身の/var/www/scripts_src をnfsでmount<br>
/var/www/scripts_src/ ・・・ここをnfsにより共有。PHPスクリプトとデータが格納されているディレクトリ<br>
※自身のディレクトリをnfsでマウントしている理由は、PHPのflockをサーバー間で機能させる目的です。</p>

<p>・サーバーA側の/etc/exports設定<br>
/var/www/scripts_src 99.100.101.*(rw,no_root_squash,async)</p>

<p>・サーバーB(IP=99.100.101.2)<br>
Webサーバーとして稼働、データやPHPスクリプトはサーバーAのものを使用<br>
/var/www/scripts/ ・・・サーバーAの/var/www/scripts_src をnfsでmount</p>

<p>・サーバーA、Bの/etc/fstabによるマウント設定<br>
99.100.101.1:/var/www/scripts_src /var/www/scripts nfs rsize=32768,wsize=32768,hard,intr,async 0 0</p>

<p>【その他】<br>
・なお上記構成前は、サーバーAの1台のみで稼働させており、50000pv/h程度でも問題なくさばけていたが、70000pv/h程度でCPUの頭打ちが出始めたため、上記複数台構成を検討しました。</p>

<p>他にも確認すべき点がございましたら、ご指摘いただければ幸いです。</p>

<p>【質問の修正履歴】<br>
-Firewall Throughputとeth0 traffic、ロードバランサの「反映」に関する記述を見直しました<br>
-2台構成以前でのサーバーの応答状況を追記しました。<br>
-サーバーAが自身のディレクトリをNFSでマウントしている理由につき、追記しました。<br>
-質問文の構成を見直しました。<br>
-サーバー監視にMuninを使用している旨を追記<br>
-CPUのIO wait とメモリのSWAP状況を追記</p>
