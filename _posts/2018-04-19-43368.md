---
layout: post
title: "Swift-ObjCの参照不備とswiftクラスのメソッドがExportされない？問題"
date: 2018-04-19 02:51:03
categories: swift ios xcode objective-c unity3d
---
<p>Unity用iOSプラグインをSwiftベースで作っております．<br>
ただし，SQLiteを使用するためFMDBをソースファイル(.m/.h)から読み込んでおります．<br>
そのためか，複数のUnityPluginをSwiftで生成するページを参照しておりますが，上手く行かず困っております．</p>

<h2>１つ目：SwiftクラスがExportされない！？</h2>

<p>次の通り，SwiftクラスをObjCから参照できるようにWrapperクラスを定義しておりますが，後述するSwiftのExampleクラスのメソッドをObj-Cから参照できず，<code>No known class method for selector 'swiftMethod'</code>というエラーがでております．</p>

<p><strong>【質問１】</strong> どうやらSwift.hにWrapperクラスから参照したいメソッドの雛形(Extern)の記述がない事から，メソッドが１つもObjective-Cから参照できない結果となっている事が原因かと思われるのですが，なぜ，Swift.hにメソッドの雛形（Extern)が記述されないのかわかる方がいらっしゃったらお教え頂けますでしょうか．</p>

<h3>Example.mm</h3>

<pre><code>#import &lt;UIKit/UIKit.h&gt;
////#import &lt;Foundation/Foundation.h&gt;
#import &lt;MyUnityPlugin-Swift.h&gt;
//// This header file is generated automatically when Xcode build runs.
//

#ifdef __cplusplus
extern "C" {
#endif
    void _ex_callSwiftMethod(const char *message) {
        // You can access Swift classes directly here.
        [Example swiftMethod]; // No known class method for selector 'swiftMethod'
        [[Example swiftMethod]Method]; // No known class method for selector 'swiftMethod'
    }
#ifdef __cplusplus
}
#endif
</code></pre>

<h3>Example.swift</h3>

<pre><code>import Foundation

public class Example : NSObject {
    public static func swiftMethod() {
        print("\(#function) message: ")
    }

    public func test(){
        print("test1 on ObjC");
    }

    public static func test2(test:NSString){
        print("test2")
    }
}

public func Test2(){
    print("test2");
}
</code></pre>

<h3>auto生成されたSwift.h</h3>

<pre><code>SWIFT_CLASS("_TtC13MyUnityPlugin7Example")
@interface Example : NSObject
- (nonnull instancetype)init OBJC_DESIGNATED_INITIALIZER;
@end
</code></pre>

<h2>２つ目：Swift-ObjCの循環参照問題</h2>

<p>Bridging-Header.hと&lt;ProjectName&gt;-Swift.h(以下,Swift.hと略)を使う事による循環参照が生じているようです．問題の発端は次です．</p>

<pre><code>Cannot find protocol declaration for 'CLLocationManagerDelegate'; did you mean 'NSLayoutManagerDelegate'?`
</code></pre>

<p>エラーを調べてみると，header/import(も含む?)の循環参照（参照不備へ訂正）だろうと推測．<br>
循環参照（参照不備へ訂正）は，Bridging-Header.hとSwift.hによるものかと推測します．</p>

<p><strong>【質問２】</strong> Swift.hに，上記原因となったCLLocationManagerDelegateを書き出されています．それはObjective-Cから参照しないので，解決策としてSwift.hに書き出さない方法をご教示いただけないでしょうか．(※ こちらはSwift.hを手動で編集する手で何とかなるのですが，毎回編集するのも負担なので，どうぞよろしくお願い致します．）</p>

<h3>Bridging-Header.h</h3>

<pre><code>// For FMDB
#import "FMDatabase.h"
#import "FMResultSet.h"
#import "FMDatabaseAdditions.h"
#import "FMDatabaseQueue.h"
#import "FMDatabasePool.h"
</code></pre>

<h3>&lt;ProjectName&gt;-Swift.h</h3>

<pre><code>// Generated by Apple Swift version 4.1 (swiftlang-902.0.48 clang-902.0.37.1)
#pragma clang diagnostic push
#pragma clang diagnostic ignored "-Wgcc-compat"

【省略】

#if __has_include(&lt;swift/objc-prologue.h&gt;)
# include &lt;swift/objc-prologue.h&gt;
#endif

#pragma clang diagnostic ignored "-Wauto-import"
#include &lt;objc/NSObject.h&gt;
#include &lt;stdint.h&gt;
#include &lt;stddef.h&gt;
#include &lt;stdbool.h&gt;

【省略】

#if __has_feature(modules)
@import UIKit;
@import ObjectiveC;
@import CoreLocation;
#endif

【省略】

@class UIWindow;
@class UIApplication;

SWIFT_CLASS("_TtC13MyUnityPlugin11AppDelegate")
@interface AppDelegate : UIResponder &lt;UIApplicationDelegate&gt;
@property (nonatomic, strong) UIWindow * _Nullable window;
- (BOOL)application:(UIApplication * _Nonnull)application didFinishLaunchingWithOptions:(NSDictionary&lt;UIApplicationLaunchOptionsKey, id&gt; * _Nullable)launchOptions SWIFT_WARN_UNUSED_RESULT;
- (void)applicationWillResignActive:(UIApplication * _Nonnull)application;
- (void)applicationDidEnterBackground:(UIApplication * _Nonnull)application;
- (void)applicationWillEnterForeground:(UIApplication * _Nonnull)application;
- (void)applicationDidBecomeActive:(UIApplication * _Nonnull)application;
- (void)applicationWillTerminate:(UIApplication * _Nonnull)application;
- (nonnull instancetype)init OBJC_DESIGNATED_INITIALIZER;
@end


SWIFT_CLASS("_TtC13MyUnityPlugin7Example")
@interface Example : NSObject
- (nonnull instancetype)init OBJC_DESIGNATED_INITIALIZER;
@end


【省略】

@class CLLocationManager;
@class CLLocation;

@interface MyLocationService (SWIFT_EXTENSION(MyUnityPlugin)) &lt;CLLocationManagerDelegate&gt;
- (void)locationManager:(CLLocationManager * _Nonnull)manager didChangeAuthorizationStatus:(CLAuthorizationStatus)status;
- (void)locationManager:(CLLocationManager * _Nonnull)manager didUpdateLocations:(NSArray&lt;CLLocation *&gt; * _Nonnull)locations;
@end

【省略】
</code></pre>
