---
layout: post
title: 複数スレッドからファイルアクセスする場合の、適切なロック方法
date: 2017-04-09 07:51:19
categories: linux c
---
<!-- {% raw %} -->
<p>C言語で複数スレッドからファイルアクセスする場合、ロックする関数についてご教示ください。</p>

<p>下記のようなプログラムを作成しています。</p>

<p>・スレッド(1)は、ファイルに対してライトします。<br>
・スレッド(2)は、スレッド(1)によってライトされたファイルに対してリードします。<br>
・必ずしもスレッド(1)(2)は同じファイルにアクセスするわけではなく、スレッドごとにfopen()します。<br>
・タイミングによってスレッド(1)(2)は同じファイルにアクセスします。</p>

<p>・（不測の自体でロックをとったままスレッドが落ちてしまった場合、他方のスレッド側ロックを強制解除して処理は継続させたいです（別途エラーメッセージはログに出力します）。</p>

<p>flock(fd,LOCK_EX)をつかってロックを取る方針で検討していたのですが、<br>
「flock()はファイル記述子ごとにロックするので、<br>
fopen()を別々に行っていては正しくロックできないのでは？」<br>
との指摘を受けて、ロックのとり方を再検討している最中です。</p>
<!-- {% endraw %} -->
