---
layout: post
title: 一時的にユニーク制約を違反してしまう場合のベストプラクティス
date: 2017-06-30 06:52:15
categories: jpa
---
<!-- {% raw %} -->
<p>JPAを使って開発しています。<br>
対象DBは、SQL Server、Oracle、PostgreSQLのいずれでも動作可能な設計です。<br>
（JPAを使っているので、実装上は特に区別しません）</p>

<p>あるマスタを保存するテーブルXに、<code>ORDER</code>という列があります。<br>
テーブルXのマスタを全て表示するときの並び順が入っています。<br>
ただ、<code>ORDER</code>の数値は重複させたくないので、ユニーク制約を設けています。</p>

<p>この並び順は、画面上でドラッグ＆ドロップで入れ替えることができるのですが、登録するときには複数のレコードに対して<code>ORDER</code>列の数値を更新します。<br>
この時、ユニーク制約の違反が発生してしまい、困っています。</p>

<p>例えば、</p>

<pre><code>ID     ORDER
A      1
B      2
C      3
</code></pre>

<p>これに対して、BとCを入れ替えるとします。<br>
その場合のクエリは、何も考えずに作ると次のようになると思います。<br>
※実際にはJPQLを使って実装しています。</p>

<pre><code>(1) UPDATE X SET ORDER = 3 WHERE ID = 'B'
(2) UPDATE X SET ORDER = 2 WHERE ID = 'C'
</code></pre>

<p>しかしこれでは、(1)を実行すると、BもCも<code>ORDER</code>が3になってしまうので、ユニーク制約違反のエラーが発生します。</p>

<p>こういった要求は割とよくあると思うのですが、どのように解決するものなのでしょうか？</p>
<!-- {% endraw %} -->
