---
layout: post
title: BigDecimalでの計算精度を保証する方法
date: 2017-10-12 07:37:13
categories: java
---
<p>ユーザが定義した計算式（<strong>有理数の四則演算のみ</strong>）を解析し、<code>BigDecimal</code>を使って計算するプログラムを作っています。<br>
ここで、「計算結果は、小数点以下2桁までが、手計算での結果と一致することを保証する」という要求仕様があります。<br>
正確には、「手計算で小数点以下第3位を四捨五入した値」との一致です。</p>

<p><code>BigDecimal</code>の<code>divide</code>メソッドは、<code>scale</code>の指定がありますが、上記の結果を保証するためには、都度の除算において、<code>scale</code>にどのような値を指定すれば良いのでしょうか？<br>
あるいは、根本的に保証できないのでしょうか？</p>

<p>結論が出ないながらも、自分で考えたことを挙げておきます。</p>

<ul>
<li>「小数点以下第3位を四捨五入」という操作が最後にあるので、結局は3桁目まで正しい状態を維持しなければならない</li>
<li><code>divide</code>に対して<code>scale=3</code>を指定したとしても、<code>1/3=0.333</code>を3000倍すると999になってしまう。小数点以下何桁の保証どころではない。

<ul>
<li><code>(1/3)*3000</code> を <code>3000*1/3</code>に組み替えるようなことをしないと、根本的に保証できない？</li>
<li>あるいは、「<strong>十分に大きな</strong><code>scale</code>を指定しておく」という方針？</li>
<li>例えば<code>scale=6</code>としたとき、<code>1/3=0.333333</code>、これを3000倍で<code>999.999</code>となる。小数点以下第3位を四捨五入すれば、<code>1000</code>になる。</li>
<li>「十分に大きなscale」とは何か？　具体的な値を定義できるか？</li>
</ul></li>
</ul>

<p>【追記】</p>

<ul>
<li>「このような計算式なら精度を保証できる」という制限付き仕様は実現可能か？

<ul>
<li><code>(a + b) / (x * y)</code>のように、「除算が高々1回」かつ「除算が最後に実行される形」であれば良い？</li>
</ul></li>
</ul>
