---
layout: post
title: DDDで集約の内部からリポジトリを使うことを避ける理由
date: 2015-08-13 11:33:02
categories: ドメイン駆動設計
---
<!-- {% raw %} -->
<p>「実践ドメイン駆動設計」には、以下のような記述があります。</p>

<blockquote>
  <p>集約の内部からリポジトリを使うことは、できる限り避けるべきだ<br>
  <em>(7章 サービス の冒頭 ...電子書籍版なのでページ番号不明)</em></p>
  
  <p>リポジトリを集約内から使って検索することもできる。このテクニックは<strong>切り離されたドメインモデル</strong>と呼ばれており、遅延読み込みの方式のひとつである。<br>
  <em>(10章 集約 - 10.4)</em></p>
  
  <p><strong>切り離されたドメインモデル</strong>は、一般的にあまり好ましくない手法だ<br>
  <em>(10章 集約 - 10.8)</em></p>
</blockquote>

<p>他にも各所に似たようなことは書かれているのですが、その理由が分かりません。<br>
一応、次のような記述もあります。</p>

<blockquote>
  <p>さらに、高トラフィックでサイズが大きく、高いパフォーマンスが求められるドメインのことを考えてみよう。…（中略）…リポジトリやドメインサービスのインスタンスを集約に注入するオーバーヘッドは、どの程度になるだろう？</p>
</blockquote>

<p>確かにアプリケーションサービスへのリポジトリのDIに比べ、インスタンスの数自体が増えやすい集約にリポジトリをDIするのは、パフォーマンス上の問題がありそうです。<br>
しかしこれは、「集約の内部からリポジトリを使うことを避ける理由」の本質なのでしょうか？</p>

<p>私の直観的には、業務ロジックを扱うドメインの中から、業務ではなく永続化の責務を担うべきリポジトリを使うのは、何となく変な気がします。<br>
ただ、そもそもリポジトリは「永続化ロジック」を抽象化したものであると考えると、抽象化してんだから良いじゃん、という気もします。<br>
つまり、まるでコレクションであるかのように扱えば（そういうインタフェースにすれば）、ドメインをあまり汚さないようにも思えるのです。</p>

<p>この<strong>切り離されたドメインモデル</strong>が「一般的にあまり好ましくない」理由の本質は一体何でしょうか？<br>
パフォーマンスのような技術的な問題以外に、「ドメインモデルの設計思想としての理由」などがありますか？</p>
<!-- {% endraw %} -->
