---
layout: post
title: Vagrantで起動したUbuntu14.04でpublic_networkを使用するとeth0がデフォルトゲートウェイの設定に失敗する
date: 2018-05-29 01:36:10
categories: ubuntu vagrant network virtualbox
---
<p><strong>環境</strong><br>
Vagrant: 2.1.1<br>
VirtualBox: 5.2.12<br>
ホスト: Windows10<br>
ゲスト: Ubuntu14.04</p>

<p><strong>現象が発生した要因</strong><br>
VM作成直後はこの現象は発生していなかった。apt-get等でパッケージの追加等を色々行っていると、いつのまにか発生するようになった？別の仮想マシン(Ubuntu16.04)では同様の設定でも現象は発生していない。</p>

<p><strong>詳細</strong></p>

<p><code>デフォルトゲートウェイの設定に失敗する</code>とは下記の症状を指します。</p>

<p><code>route</code>コマンドでdefaultが表示されない。eth0がNAT, eth1がホストオンリーアダプタ(private_network), eth2がブリッジアダプタ(public_network)です。</p>

<pre><code>vagrant@vagrant:~$ route
カーネルIP経路テーブル
受信先サイト    ゲートウェイ    ネットマスク   フラグ Metric Ref 使用数 インタフェース
10.0.2.0        *               255.255.255.0   U     0      0        0 eth0
172.28.128.0    *               255.255.255.0   U     0      0        0 eth1
192.168.254.0   *               255.255.255.0   U     0      0        0 eth2
</code></pre>

<p>本来期待する結果は下記の通りです。</p>

<pre><code>vagrant@vagrant:~$ route 
カーネルIP経路テーブル 
受信先サイト    ゲートウェイ    ネットマスク   フラグ Metric Ref 使用数 インタフェース
default         10.0.2.2        0.0.0.0         UG    0      0        0 eth0
10.0.2.0        *               255.255.255.0   U     0      0        0 eth0
172.28.128.0    *               255.255.255.0   U     0      0        0 eth1
192.168.254.0   *               255.255.255.0   U     0      0        0 eth2
</code></pre>

<p>Vagrantfileでは下記のように設定しています。</p>

<pre><code>Vagrant.configure("2") do |config|
  config.vm.network "public_network", type: "dhcp"
end
</code></pre>

<p>起動後、手動でeth0を再起動させると、defaultが表示されるようになります。</p>

<pre><code>sudo ifdown eth0 &amp;&amp; sudo ifup eth0
vagrant@vagrant:~$ route 
カーネルIP経路テーブル 
受信先サイト    ゲートウェイ    ネットマスク   フラグ Metric Ref 使用数 インタフェース
default         10.0.2.2        0.0.0.0         UG    0      0        0 eth0
10.0.2.0        *               255.255.255.0   U     0      0        0 eth0
172.28.128.0    *               255.255.255.0   U     0      0        0 eth1
192.168.254.0   *               255.255.255.0   U     0      0        0 eth2
</code></pre>

<p><code>/etc/network/interfaces</code>のpost-upの行をコメントアウトし、VirtualBoxから直接起動した場合もdefaultが表示されます。 (defaultがeth2になっていますが)</p>

<pre><code>#VAGRANT-BEGIN
# The contents below are automatically generated by Vagrant. Do not modify.
auto eth2
iface eth2 inet dhcp
    # post-up ip route del default dev $IFACE || true
#VAGRANT-END

vagrant@vagrant:~$ route
カーネルIP経路テーブル
受信先サイト    ゲートウェイ    ネットマスク   フラグ Metric Ref 使用数 インタフェース
default         192.168.254.1   0.0.0.0         UG    0      0        0 eth2
10.0.2.0        *               255.255.255.0   U     0      0        0 eth0
172.28.128.0    *               255.255.255.0   U     0      0        0 eth1
192.168.254.0   *               255.255.255.0   U     0      0        0 eth2
</code></pre>

<p>何か原因や、確認すべきポイントはわからないでしょうか？</p>

<p><strong>追記</strong><br>
今回はデフォルトゲートウェイはethNのどれでもよかったので、public_networkの設定を下記のようにすることで、eth2がデフォルトゲートウェイとして設定されるようになりました。</p>

<pre><code>Vagrant.configure("2") do |config|
  config.vm.network "public_network", type: "dhcp", use_dhcp_assigned_default_route: true
end
</code></pre>

<p>ただ、この質問で知りたいのは、なぜeth0が自動的にデフォルトゲートウェイとして設定されないのか、です。<br>
情報をお持ちの方は引き続きよろしくお願いします。</p>

<p><strong>@cubickさんのコメントを受けて追記</strong></p>

<p>下記の通り、public_networkを使用した場合だけ現象が発生します。</p>

<p><strong>成功</strong></p>

<ul>
<li>NATのみ</li>
<li>NAT + private_network</li>
</ul>

<p><strong>失敗</strong></p>

<ul>
<li>NAT + public_network</li>
<li>NAT + private_network + public_network</li>
</ul>
