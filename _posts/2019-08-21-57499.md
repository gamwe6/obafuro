---
layout: post
title: Laravel の throttle を引き上げたのに 429 がでる
date: 2019-08-21 03:05:48
categories: laravel
---
<!-- {% raw %} -->
<p><a href="https://www.google.com/search?q=laravel+429+throttle" rel="nofollow noreferrer">https://www.google.com/search?q=laravel+429+throttle</a></p>

<p>Laravel はデフォルトで同一IPからの１分あたりの接続数を制限する機能があって<br>
それをこえると 429 too many attempts を返すようなのです</p>

<p>どの記事も対策として throttle をひきあげろとかいていて</p>

<p>app/Http/Kernel.php </p>

<pre><code>'api' =&gt; [
   'throttle:4000,1',
   'bindings',
 ],
</code></pre>

<p>のところを 60 だったのを 600 => 1000 => 4000 と段階的にあげてデプロイしたんですが<br>
依然として 429 が出続けます</p>

<p>これまでは正確に数えたわけではないのですが 1000 までは認識されてる（429の頻度が減った)<br>
感じがする(少なくとも 60 => 600 の時点では確実に減った）のですが <br>
分間 4000 件のアクセスは確実にしていないのに依然として 429 がでてくるので<br>
設定値に上限があったりするのでしょうか？</p>

<pre><code>sudo cat /var/log/nginx/access.log | grep '" 429' -B 4000 | grep xxx.xxx.xxx.xxx
</code></pre>

<p>で 429 を出してから同一IPのログを調べてみたんですが</p>

<pre><code>ログの行数　タイムスタンプ　　　　　　　　　　　ステータス
0        [21/Aug/2019:00:11:46 +0000] 200
325      [21/Aug/2019:00:12:04 +0000] 200
326      [21/Aug/2019:00:12:04 +0000] 429
599      [21/Aug/2019:00:12:46 +0000] 429
</code></pre>

<p>このようになっていて 12:46 が最後の 429 だったのでこのタイミングでリセットされたんだろうということで<br>
 1 分前 11:46 からのカウントをはじめて 325 件のところで 429 が出始めて <br>
1 分たった 600件のところで 429 がとまった(429 が 274 件でた)という感じです</p>

<p>ちなみにこのAPIサーバーは内向きで<br>
外向きのAPIサーバー６台から（＋ヘルスチェックがごく小数回）のみ接続をうけていて<br>
429が出るときは常に同じIPに対してのみなので６台の合計というわけでもなさそうです</p>

<p>サーバー内のソースもきちんと 4000 になって反映されてるし<br>
nginx も何度も再起動してマスタープロセス起動時間もデプロイ後の時間になってます</p>

<p>4000 には程遠い件数で 429 が出始めるのはなぜなんでしょうか</p>
<!-- {% endraw %} -->
