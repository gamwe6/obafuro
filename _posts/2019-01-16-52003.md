---
layout: post
title: "ダブルクオートで囲まれていない範囲で置換をしたい"
date: 2019-01-16 04:37:44
categories: 正規表現 vim
---
<p>こんにちは。大学生です。<br>
ダブルクオートで囲まれていない範囲で置換をしようとして困っています。<br>
一度の置換でなくて構いません。<br>
vimで置換をしていまして、ソースコード中の/の前後に半角空白を入れる置換をしようとしています。<br>
例としては「a/b」を「a / b」のようにしたいです。</p>

<p>以下、やってみたことです。<br>
pythonにある切り捨て除算//は<br>
a<code>//</code>b を前もって別の文字列にして、<br>
この処理の後にa<code>//</code>bにする処理を入れます。</p>

<p>調べたところ「あいaうえお」を「あいbうえお」に置換するには<br>
<code>:%s/\(.*)a\(.*)/\1b\2/g</code><br>
のようにすると良いとわかりました。<br>
すでに前後に半角空白を実行ごとに増やさないようにしつつ、<br>
いまこのような置換コマンドを作りました。<br>
<code>:%s;\([^\s/]\)\s*/\s*\([^\s/]\);\1 / \2;ge</code><br>
わかりづらいので改行を入れますと、<br>
<code>:%s</code>　　　　　ファイル全体を置換<br>
<code>;</code>　　　　　　区切りを;にする　よくある<code>:%s/a/b/g</code>を<code>:%s;f;b;g</code>に<br>
<code>\([^\s/]\)</code>　 グループ\1 スラッシュと空白以外の文字<br>
<code>\s*</code>　　　　　スラッシュの前にある0個以上の空白<br>
<code>/</code>　　　　　　目的のスラッシュ<br>
<code>\s*</code>　　　　　スラッシュの前にある0個以上の空白<br>
<code>\([^\s/]\)</code>　 グループ\2 スラッシュと空白以外の文字<br>
<code>;</code>　　　　　　置換前と置換後の区切り文字<br>
<code>\1 / \2</code>　　　グループ1と2で_/_を挟む<br>
<code>;ge</code>　　　　　もしマッチしなくてもエラーを表示しない</p>

<p>しかしソースコード中にダブルクォートで囲まれたパスが存在するため、<br>
このままでは「"/home/user/a.png"」が「" / home / user / a.png"」のようになってしまいます。<br>
このため””で囲まれていない範囲で置換を行いたいです。<br>
(シングルクォートはこの際無視します_(┐「ε:)_)</p>

<p>コードフォーマッタを使うといいと思われると思いますが、<br>
ソースコードはCやPython,Haskellなど複数種類あり、<br>
都合の良いコードフォーマッタがありません。<br>
そのためvimのコマンドとして関数を定義し、<br>
.vimrcに書き、必要な時に呼び出したいと思います。<br>
ある程度の副作用はその都度コマンドを修正していき、<br>
最終的には僕の考えた最強の/を置換するコマンド、<br>
という微妙なものを作りたいと思います。</p>

<p>調べたところ、条件が異なる回答ではありますが<br>
「かっこ[]で囲まれた文字以外をマッチさせたい」という質問の回答で</p>

<blockquote>
  <p>先読みを利用すれば出来ると思います。<br>
  マッチさせる箇所(A)を<code>[^\[\]]+</code>、させない箇所(B)を<code>\[[^\[\]]+\]</code>だとすると、先読みさせるにはA(?=B)、つまり<code>[^\[\]]+(?=\[[^\[\]]+\])</code>という形になります。これと末尾(もしくは全体)にマッチするパターン<code>A$=[^\[\]]+$</code>を組み合わせれば<br>
  <code>([^\[\]]+(?=\[[^\[\]]+\])|[^\[\]]+$)</code><br>
  となります。<br>
  <a href="https://ja.stackoverflow.com/a/9032/31797">https://ja.stackoverflow.com/a/9032/31797</a></p>
</blockquote>

<p>というのを見つけ、これを使えばうまくできるのではないかと考えています。先読みというのが初めてでvimの正規表現では<br>
<a href="https://vim-jp.org/vim-users-jp/2009/09/20/Hack-75.html" rel="nofollow noreferrer">https://vim-jp.org/vim-users-jp/2009/09/20/Hack-75.html</a><br>
<a href="http://d.hatena.ne.jp/unk_pizza/20140311/p1" rel="nofollow noreferrer">http://d.hatena.ne.jp/unk_pizza/20140311/p1</a><br>
を見て、条件となるパターン①とマッチさせたいパターン②の2つを用いてパターンマッチさせる方法であると理解しました。<br>
(自信はありません_(┐「ε:)_)</p>

<p>私の場合、①でない全ての②を置換後文字列③にする否定先読み、否定後読みを用いるのが良いと考えました。<br>
この場合、①条件となるパターンと、②マッチさせたいパターン、③置換後文字列は<br>
①「""」で囲まれている文字列<br>
②「/」 すでに前後に空白がある時はそれも含む<br>
③「/の前の文字列」半角空白/半角空白「/の後の文字列」 <br>
となるのでしょうか。<br>
ここから正規表現にするところで止まっています。</p>

<p>正規表現でダメだったら、1行読み込んで"があるかどうか判定、<br>
"がなければ前述の置換、あれば"までの文字列と”の中の文字列、 "の後の文字列に分けて""以外の文字列に置換、というのを書こうと思います_(┐「ε:)_</p>
