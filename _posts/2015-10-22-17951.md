---
layout: post
title: .htaccessでのリダイレクト時にURLが二重にパーセントエンコードされてしまう
date: 2015-10-22 09:46:58
categories: php apache laravel
---
<p>キーワード検索機能を持つブログで、検索結果の2ページ目にキーワードを引き継ぐためにGETを用いて「?s=キーワード&amp;page=ページ」の形にしています。<br>
実際にはマルチバイト文字はエスケープされるので「あ」は「%E3%81%82」に置き換えられて次のようになっています。</p>

<pre><code>http://example.com/blog/?s=%E3%81%82&amp;amp;page=2
</code></pre>

<p>しかし、そのリンクにアクセスしてみるとすぐにリダイレクトされて下記のアドレスに転送されます。「%」が「%25」に置き換えられてしまっています。</p>

<pre><code>http://example.com/blog?s=%25E3%2581%2582&amp;page=2
</code></pre>

<p>転送の原因は末尾のスラッシュを消すための処理を.htaccessに記述しているせいです。</p>

<pre><code>RewriteRule ^(.*)/$ /$1 [L,R=301]
</code></pre>

<p>この処理をなくすか、URLを「〜blog/?s=」の代わりに「〜blog?s=」となるようにリンクを作成するとリダイレクトは発生しないので正しいURLにアクセスすることができます。<br>
しかし、使用しているフレームワーク(Laravel 5.0)のページネーション機能 render() で出力すると不要な末尾の「/」が付加されてしまいます。</p>

<p>・Laravel のビュー部分</p>

<pre><code>{!! $posts-&gt;render() !!}
</code></pre>

<p>理想はフレームワーク側で末尾にスラッシュを付けずに render() によるページナビ出力をしたいのですが、.htaccess 側で対処できるのであればそれでも構いません。<br>
リダイレクト時にGETパラメータを正しく保持したままにするにはどうすれば良いのでしょうか？</p>
