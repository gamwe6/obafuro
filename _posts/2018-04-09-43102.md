---
layout: post
title: AWS VPCとオンプレ間のVPN通信ができない
date: 2018-04-09 13:52:30
categories: aws vpn vpc
---
<!-- {% raw %} -->
<p>表記にかかる質問をさせてください。<br>
AWS VPCを構成し、オンプレ（自宅）に設置したvyosサーバ(VPN)間での通信が行えません。<br>
現在実施していることは以下のとおりです。</p>

<p>前提　<br>
　オンプレ側のネットワークは192.168.11.0/24、AWS側は192.168.12.0/24、192.168.13.0/24  → プライベートアドレスです。</p>

<p>[AWS側]<br>
１　VPC<br>
・専用のVPCを作成し、2つのCIDRブロックを設定（192.168.12.0/24、192.168.13.0/24）<br>
・２つのサブネットを設定（192.168.12.0/24、192.168.13.0/24）<br>
・ルートテーブルは以下のとおり。（ルート、ターゲット）<br>
　　192.168.12.0/24 local<br>
　　192.168.13.0/24 local<br>
　　0.0.0.0/0 インターネットゲートウェイ<br>
　　192.168.11.0/24 仮想プライベートゲートウェイ<br>
・１つのインターネットゲートウェイを設定（VPCにアタッチ）<br>
・ネットワークACLは以下のとおり<br>
　　インバウンドルール　<br>
　　　100 全てのトラフィック　全てのプロトコル　ソース　192.168.11.0/24 許可<br>
　　　* デフォルトの拒否ルールです<br>
　　アウトバウンドルール<br>
　　　デフォルトのまま（0.0.0.0/24の許可と拒否が設定されているもの）<br>
・セキュリティグループは以下のとおり。　→後述するEC2インスタンスに紐づけたもの<br>
　　インバウンドルール<br>
　　　すべての トラフィック　すべて　すべて　192.168.11.0/24<br>
　　　すべての ICMP - IPv4 ICMP (1) すべて　::/0<br>
　　アウトバウンドルール<br>
　　　すべての トラフィック　すべて　すべて　0.0.0.0/0<br>
・カスタマーゲートウェイ<br>
　　VPCにアタッチし、BGPASNはデフォルトの65000<br>
・仮想プライベートゲートウェイ<br>
　　上記に紐づけて、AmazonASNはデフォルトの10124<br>
・VPN接続<br>
　　ルーティングはダイナミック、カスタマーGWアドレスは自宅のルータアドレス（インターネット側）</p>

<p>2 EC2<br>
・EC2インスタンス（AmazonLinux)を立ち上げ、VPCにアタッチ。プライベートアドレスは192.168.12.10とした。（ElasitIPは不要なため設定なし）</p>

<p>[自宅側]<br>
構成は以下のとおり。<br>
デフォルトGW 自宅ルータ　192.168.11.1<br>
VPNルータ（vyos）　192.168.11.2 eth1に設定し、NICは１つのみ<br>
AWSVPCでダウンロードした設定を反映（set vpn ipsec site-to-site peerのローカルIPは192.168.11.2に変更）</p>

<p>上記設定を反映したところ、VPN(ipsec)は問題なく張られ、VPC側では問題なくUP状態になっています。また、VPCから見えるvpnトンネルのIP(外部アドレス)に対して、vyos（自宅）からpingを通すと問題なし。<br>
しかし、EC2に対して、pingやSSH（AWS発行の鍵利用）を実行しても通信できない状態になっています。<br>
Wiresharkでpingをモニタリングしたところ、vyosからAWS側の外部IPに対してESPで通信しているところはわかりますが、VPC側のフローログを確認しましたがログは拾えていない（届いていない）ようでした。</p>

<p>考えられる原因はなにかわかりますでしょうか。そもそもこの構成（VPNサーバ→自宅ルータ→インターネット→VPC→EC2)が正しく機能するのかをご教授ねがえますでしょうか。</p>
<!-- {% endraw %} -->
